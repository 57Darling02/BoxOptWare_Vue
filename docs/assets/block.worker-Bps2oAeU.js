var $=Object.defineProperty;var D=(l,t,s)=>t in l?$(l,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):l[t]=s;var f=(l,t,s)=>D(l,typeof t!="symbol"?t+"":t,s);const T=["#FFCCCC","#CCFFCC","#CCCCFF","#FFFFCC","#FFCCFF","#CCFFFF"],g=["#8B0000","#006400","#00008B","#8B8B00","#8B008B","#008B8B"];function N(l){const t=l%T.length;return T[t]}function O(l){const t=l%g.length;return g[t]}const p=new Map;function X(l){return l.slice().sort((t,s)=>t-s).join("-")}function H(l){const t=X(l);let s;return p.has(t)?s=p.get(t):(s=p.size%g.length,p.set(t,s)),g[s]}const w=class w{constructor(){f(this,"index");this.index=w.currentIndex++}};f(w,"currentIndex",0);let C=w;class A extends C{constructor(s,n,e=O(C.currentIndex-1),r=!1,c=1,o=!1,a="corner",x=-1){super();f(this,"centerPosition");f(this,"cornerPosition");if(this.size=s,this.position=n,this.color=e,this.transparent=r,this.opacity=c,this.wireframe=o,this.positionType=a,this.id=x,a==="center"){this.centerPosition=n;const[u,i,y]=s.map(h=>h/2);this.cornerPosition=[n[0]-u,n[1]-i,n[2]-y]}else{this.cornerPosition=n;const[u,i,y]=s.map(h=>h/2);this.centerPosition=[n[0]+u,n[1]+i,n[2]+y]}}}class S extends A{constructor(t,s,n="#ffffff",e=!0,r=.5,c=!0,o="corner"){super(t,s,n,e,r,c,o)}}class B extends A{constructor(t,s,n=1,e="",r=!1,c=1,o=!1,a="corner",x=-1){super(t,s,e,r,c,o,a,x),this.mass=n,this.color===""&&(this.color=H(this.size))}toPlainObject(){return{size:this.size,position:this.position,mass:this.mass,color:this.color,transparent:this.transparent,opacity:this.opacity,wireframe:this.wireframe,positionType:this.positionType}}static fromPlainObject(t){return new B(t.size,t.position,t.mass,t.color,t.transparent,t.opacity,t.wireframe,t.positionType)}}class I{constructor(){f(this,"items",[])}get isEmpty(){return this.items.length===0}get size(){return this.items.length}push(...t){this.items.push(...t)}pop(){return this.items.pop()}peek(){return this.items[this.items.length-1]}clear(){this.items=[]}}class W{constructor(t,s,n,e=0){this.lx=t,this.ly=s,this.lz=n,this.id=e}}class _{constructor(t,s,n,e,r,c,o=null){this.x=t,this.y=s,this.z=n,this.lx=e,this.ly=r,this.lz=c,this.origin=o}isEqual(t){return t==null?!1:this.x===t.x&&this.y===t.y&&this.z===t.z&&this.lx===t.lx&&this.ly===t.ly&&this.lz===t.lz}}class Y{constructor(t,s,n){this.container=t,this.box_list=s,this.num_list=n}}class R{constructor(t,s,n,e=[],r=[],c=null){f(this,"volume",0);f(this,"ax",0);f(this,"ay",0);f(this,"times",0);f(this,"fitness",0);this.lx=t,this.ly=s,this.lz=n,this.require_list=e,this.children=r,this.direction=c}isEqual(t){return t==null?!1:this.lx===t.lx&&this.ly===t.ly&&this.lz===t.lz&&this.ax===t.ax&&this.ay===t.ay&&this.require_list.every((s,n)=>s===t.require_list[n])}}class Z{constructor(t,s){this.space=t,this.block=s}isEqual(t){return this.space.isEqual(t.space)&&this.block.isEqual(t.block)}}class k{constructor(t=[],s=new I,n=[]){f(this,"volume",0);f(this,"volume_complete",0);this.plan_list=t,this.space_stack=s,this.avail_list=n}}const G=.5,K=.9,L=5;function F(l,t,s){return l.lx<=t.lx&&l.ly<=t.ly&&l.lz<=t.lz&&l.require_list.every((n,e)=>n<=s[e])&&l.volume/(l.lx*l.ly*l.lz)>=G&&l.ax*l.ay/(l.lx*l.ly)>=K&&l.times<=L}function M(l,t,s){s.require_list=l.require_list.map((n,e)=>n+t.require_list[e]),s.volume=l.volume+t.volume,s.children=[l,t],s.times=Math.max(l.times,t.times)+1}function J(l,t,s){const n=[];for(const e of t)for(let r=1;r<=s[e.id];r++)for(let c=1;c<=Math.floor(s[e.id]/r);c++)for(let o=1;o<=Math.floor(s[e.id]/(r*c));o++)if(e.lx*r<=l.lx&&e.ly*c<=l.ly&&e.lz*o<=l.lz){const a=Array(s.length).fill(0);a[e.id]=r*c*o;const x=new R(e.lx*r,e.ly*c,e.lz*o,a);x.ax=e.lx*r,x.ay=e.ly*c,x.volume=e.lx*r*e.ly*c*e.lz*o,x.times=0,n.push(x)}return n.sort((e,r)=>r.volume-e.volume)}function Q(l,t,s){let n=J(l,t,s);for(let e=0;e<L;e++){const r=[];for(let o=0;o<n.length;o++){const a=n[o];for(let x=0;x<n.length;x++){if(o===x)continue;const u=n[x];if(a.times===e||u.times===e){const i=new R(0,0,0);if(a.ax===a.lx&&u.ax===u.lx&&a.lz===u.lz&&(i.direction="x",i.ax=a.ax+u.ax,i.ay=Math.min(a.ay,u.ay),i.lx=a.lx+u.lx,i.ly=Math.max(a.ly,u.ly),i.lz=a.lz,M(a,u,i),F(i,l,s))){r.push(i);continue}if(a.ay===a.ly&&u.ay===u.ly&&a.lz===u.lz&&(i.direction="y",i.ax=Math.min(a.ax,u.ax),i.ay=a.ay+u.ay,i.lx=Math.max(a.lx,u.lx),i.ly=a.ly+u.ly,i.lz=a.lz,M(a,u,i),F(i,l,s))){r.push(i);continue}a.ax>=u.lx&&a.ay>=u.ly&&(i.direction="z",i.ax=u.ax,i.ay=u.ay,i.lx=a.lx,i.ly=a.ly,i.lz=a.lz+u.lz,M(a,u,i),F(i,l,s)&&r.push(i))}}}n=[...n,...r];const c=new Map;n.forEach(o=>{const a=`${o.lx}-${o.ly}-${o.lz}-${o.ax}-${o.ay}-${o.require_list.join("-")}`;c.set(a,o)}),n=Array.from(c.values())}return n.sort((e,r)=>r.volume-e.volume)}function V(l,t,s){return s.filter(n=>n.require_list.every((e,r)=>e<=t[r])&&n.lx<=l.lx&&n.ly<=l.ly&&n.lz<=l.lz)}function j(l,t){const s=l.lx-t.lx,n=l.ly-t.ly,e=l.lz-t.lz;if(s>=n){const r=new _(l.x+t.lx,l.y,l.z,s,l.ly,l.lz,l),c=new _(l.x,l.y+t.ly,l.z,t.lx,n,l.lz,l);return[new _(l.x,l.y,l.z+t.lz,t.ax,t.ay,e,null),c,r]}else{const r=new _(l.x+t.lx,l.y,l.z,s,t.ly,l.lz,l),c=new _(l.x,l.y+t.ly,l.z,l.lx,n,l.lz,l);return[new _(l.x,l.y,l.z+t.lz,t.ax,t.ay,e,null),r,c]}}function b(l,t){if(t.size<=1)return t.pop(),null;const s=l;t.pop();const n=t.peek();if(s.origin&&n&&s.origin.isEqual(n.origin)){const e=new _(n.x,n.y,n.z,n.lx,n.ly,n.lz,n.origin);if(s.lx===s.origin.lx)e.ly=s.origin.ly;else if(s.ly===s.origin.ly)e.lx=s.origin.lx;else return null;return t.pop(),t.push(e),n}return null}function tt(l,t,s,n){return t[0]}function lt(l,t,s){let n;n=Q(s.container,s.box_list,s.num_list);const e=new k([],new I,[...s.num_list]);for(e.space_stack.push(s.container);e.space_stack.size>0;){const r=e.space_stack.peek();if(r){const c=V(r,e.avail_list,n);if(c.length>0){const o=tt(e,c);e.space_stack.pop(),e.avail_list=e.avail_list.map((i,y)=>i-o.require_list[y]),e.plan_list.push(new Z(r,o)),e.volume=e.volume+o.volume;const[a,x,u]=j(r,o);e.space_stack.push(a,x,u)}else b(r,e.space_stack)}}return e}function U(l,t,s){if(l.children.length<=0&&l.times===0){const e=l.require_list.findIndex(r=>r>0);if(e>-1){const r=s[e],c=l.lx/r.lx,o=l.ly/r.ly,a=l.lz/r.lz,x=[];for(let h=0;h<c;h++)x.push(h*r.lx);const u=[];for(let h=0;h<o;h++)u.push(h*r.ly);const i=[];for(let h=0;h<a;h++)i.push(h*r.lz);const y=[];for(const h of x)for(const z of u)for(const v of i)y.push([h+t[0],z+t[1],v+t[2],r.lx,r.ly,r.lz,e]);return y.sort((h,z)=>h[0]!==z[0]?h[0]-z[0]:h[1]!==z[1]?h[1]-z[1]:h[2]-z[2])}return[]}let n=[];for(const e of l.children)n=n.concat(U(e,t,s)),l.direction==="x"?t=[t[0]+e.lx,t[1],t[2]]:l.direction==="y"?t=[t[0],t[1]+e.ly,t[2]]:l.direction==="z"&&(t=[t[0],t[1],t[2]+e.lz]);return n}function P(l){let t=0,s=0,n=0,e=0;for(const a of l){const x=a.mass,u=a.centerPosition;t+=x,s+=u[0]*x,n+=u[1]*x,e+=u[2]*x}if(t===0)return[0,0,0];const r=s/t,c=n/t,o=e/t;return[r,c,o]}const st=l=>{const{name:t,containers:s,boxes:n,num_list:e}=l,r=s.map(i=>new _(i.x,i.y,i.z,i.lx,i.ly,i.lz)),c=n.map(i=>new W(i.lx,i.ly,i.lz,i.id));let o={modules:[],container:{name:t,volumn:0,boxesvolumn:0,volumnUR:0,gravityCenter:[0,0,0],allmodules:[],allbox:[],restBoxnum:[]}},a=[...e],x=0,u=[];for(const i of r){let y={name:s[x++].name,x:i.x,y:i.y,z:i.z,lx:i.lx,ly:i.ly,lz:i.lz,boxes:[],volumn:0,boxesvolumn:0,volumnUR:0,gravityCenter:[0,0,0],num_list:[],showModule:new S([i.lx,i.ly,i.lz],[i.x,i.y,i.z],void 0,void 0,void 0,void 0,"corner")};o.container.allmodules.push(y.showModule);const h=new Y(i,c,a),v=lt(!0,{},h);for(const d of v.plan_list){const q=U(d.block,[d.space.x,d.space.y,d.space.z],h.box_list);for(const m of q){const E=new B([m[3],m[4],m[5]],[m[0],m[1],m[2]],n[m[6]].mass,N(n[m[6]].id),!0,.5,!1,"corner",n[m[6]].id);y.boxes.push(E),o.container.allbox.push(E)}}if(y.boxesvolumn=v.volume,y.volumn=y.lx*y.ly*y.lz,y.volumnUR=y.boxesvolumn/y.volumn,y.gravityCenter=P(y.boxes),u.push(...y.boxes),y.num_list=a.map((d,q)=>d-v.avail_list[q]),a=v.avail_list,o.modules.push(y),o.container.boxesvolumn+=y.boxesvolumn,o.container.volumn+=y.volumn,a.every(d=>d===0))break}return o.container.gravityCenter=P(u),o.container.volumnUR=o.container.boxesvolumn/o.container.volumn,o.container.restBoxnum=a,o};self.onmessage=async l=>{try{if(l.data.type==="CALCULATE"){const t=st(l.data.data);self.postMessage({type:"SUCCESS",data:t})}}catch(t){self.postMessage({type:"ERROR",error:t instanceof Error?t.message:"未知错误"})}};
